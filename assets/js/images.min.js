const imageConfig={lazyLoadThreshold: '50px',fadeInDuration: 300,defaultQuality: 85,retinaQuality: 75,supportedFormats: ['webp','avif','jpg','png'],placeholderColor: '#f0f0f0',placeholderText: 'ðŸ“·',maxConcurrentLoads: 3,retryAttempts: 2,retryDelay: 1000};let imageLoadQueue=[];let currentlyLoading=0;let intersectionObserver=null;let imageCache=new Map();function initImageOptimization(){initLazyLoading();optimizeExistingImages();initResponsiveImages();initImageErrorHandling();initImageAnalytics();preloadCriticalImages()}function initLazyLoading(){if(!('IntersectionObserver' in window)){loadAllImages();return}const observerOptions={root: null,rootMargin: imageConfig.lazyLoadThreshold,threshold: 0.01};intersectionObserver=new IntersectionObserver((entries)=>{entries.forEach(entry=>{if(entry.isIntersecting){loadImage(entry.target);intersectionObserver.unobserve(entry.target)}})},observerOptions);const lazyImages=document.querySelectorAll('img[data-src],img[loading="lazy"]');lazyImages.forEach(img=>{setupLazyImage(img);intersectionObserver.observe(img)})}function setupLazyImage(img){img.classList.add('img-lazy');if(!img.src&&!img.dataset.src){img.src=generatePlaceholder(img)}if(!img.hasAttribute('loading')){img.setAttribute('loading','lazy')}if(!img.alt){img.alt=generateAltText(img)}img.addEventListener('error',()=>handleImageError(img));img.addEventListener('load',()=>handleImageLoad(img))}async function loadImage(img){if(img.classList.contains('img-loaded')||img.classList.contains('img-loading')){return}if(currentlyLoading>=imageConfig.maxConcurrentLoads){imageLoadQueue.push(img);return}currentlyLoading++;img.classList.add('img-loading');try{const imageSrc=img.dataset.src||img.src;const optimizedSrc=await getOptimizedImageSrc(imageSrc,img);await preloadImage(optimizedSrc);img.src=optimizedSrc;trackImageEvent('image_loaded',{src: optimizedSrc,width: img.width||img.naturalWidth,height: img.height||img.naturalHeight})}catch(error){handleImageError(img,error)}finally{currentlyLoading--;processImageQueue()}}function processImageQueue(){if(imageLoadQueue.length>0&&currentlyLoading<imageConfig.maxConcurrentLoads){const nextImage=imageLoadQueue.shift();loadImage(nextImage)}}async function getOptimizedImageSrc(originalSrc,imgElement){const cacheKey=`${originalSrc}_${imgElement.width||'auto'}_${imgElement.height||'auto'}`;if(imageCache.has(cacheKey)){return imageCache.get(cacheKey)}let optimizedSrc=originalSrc;optimizedSrc=applyResponsiveSizing(optimizedSrc,imgElement);optimizedSrc=await applyFormatOptimization(optimizedSrc);optimizedSrc=applyQualityOptimization(optimizedSrc,imgElement);imageCache.set(cacheKey,optimizedSrc);return optimizedSrc}function applyResponsiveSizing(src,imgElement){const containerWidth=imgElement.parentElement?.offsetWidth||window.innerWidth;const devicePixelRatio=window.devicePixelRatio||1;const targetWidth=Math.min(containerWidth*devicePixelRatio,2000);if(src.startsWith('assets/')||src.startsWith('./assets/')){return src}const url=new URL(src,window.location.origin);url.searchParams.set('w',Math.round(targetWidth).toString());url.searchParams.set('fit','cover');url.searchParams.set('auto','format');return url.toString()}async function applyFormatOptimization(src){const supportsWebP=await checkFormatSupport('webp');const supportsAVIF=await checkFormatSupport('avif');if(src.startsWith('assets/')||src.startsWith('./assets/')){return src}const url=new URL(src,window.location.origin);if(supportsAVIF){url.searchParams.set('format','avif')}else if(supportsWebP){url.searchParams.set('format','webp')}return url.toString()}function checkFormatSupport(format){return new Promise((resolve)=>{const canvas=document.createElement('canvas');canvas.width=1;canvas.height=1;const ctx=canvas.getContext('2d');ctx.fillStyle='#000';ctx.fillRect(0,0,1,1);canvas.toBlob((blob)=>{resolve(blob!==null)},`image/${format}`)})}function applyQualityOptimization(src,imgElement){if(src.startsWith('assets/')||src.startsWith('./assets/')){return src}const isRetina=window.devicePixelRatio>1;const quality=isRetina ? imageConfig.retinaQuality : imageConfig.defaultQuality;const url=new URL(src,window.location.origin);url.searchParams.set('q',quality.toString());return url.toString()}function preloadImage(src){return new Promise((resolve,reject)=>{const img=new Image();img.onload=()=>resolve(img);img.onerror=()=>reject(new Error(`Failed to load image: ${src}`));img.src=src})}function handleImageLoad(img){img.classList.remove('img-loading');img.classList.add('img-loaded');img.style.opacity='0';img.style.transition=`opacity ${imageConfig.fadeInDuration}ms ease-in-out`;requestAnimationFrame(()=>{img.style.opacity='1'});if(img.dataset.src){delete img.dataset.src}}function handleImageError(img,error=null){img.classList.remove('img-loading');img.classList.add('img-error');const fallbackSrc=generateErrorPlaceholder(img);if(img.src!==fallbackSrc){img.src=fallbackSrc}trackImageEvent('image_error',{src: img.dataset.src||img.src,error: error?.message||'Unknown error',alt: img.alt});console.warn('Image failed to load:',img.dataset.src||img.src,error)}function generatePlaceholder(img){const width=img.width||img.offsetWidth||300;const height=img.height||img.offsetHeight||200;const svg=`<svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg"><rect width="100%" height="100%" fill="${imageConfig.placeholderColor}"/><text x="50%" y="50%" text-anchor="middle" dy=".3em" font-family="Arial,sans-serif" font-size="24" fill="#999">${imageConfig.placeholderText}</text></svg>`;return `data:image/svg+xml;base64,${btoa(svg)}`}function generateErrorPlaceholder(img){const width=img.width||img.offsetWidth||300;const height=img.height||img.offsetHeight||200;const svg=`<svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg"><rect width="100%" height="100%" fill="#f8f8f8" stroke="#ddd" stroke-width="2"/><text x="50%" y="45%" text-anchor="middle" dy=".3em" font-family="Arial,sans-serif" font-size="16" fill="#666">Image not available</text><text x="50%" y="60%" text-anchor="middle" dy=".3em" font-family="Arial,sans-serif" font-size="12" fill="#999">ðŸ“·</text></svg>`;return `data:image/svg+xml;base64,${btoa(svg)}`}function generateAltText(img){const src=img.dataset.src||img.src;const filename=src.split('/').pop().split('.')[0];const altText=filename .replace(/[-_]/g,' ').replace(/([a-z])([A-Z])/g,'$1 $2').toLowerCase().replace(/\b\w/g,l=>l.toUpperCase());return altText||'Image'}function optimizeExistingImages(){const images=document.querySelectorAll('img:not([data-src]):not(.img-lazy)');images.forEach(img=>{if(!img.hasAttribute('loading')&&!img.classList.contains('hero__photo')){img.setAttribute('loading','lazy')}if(!img.alt){img.alt=generateAltText(img)}img.addEventListener('error',()=>handleImageError(img));img.classList.add('img-optimized')})}function initResponsiveImages(){let resizeTimeout;window.addEventListener('resize',()=>{clearTimeout(resizeTimeout);resizeTimeout=setTimeout(()=>{updateResponsiveImages()},250)});if('matchMedia' in window){const mediaQuery=window.matchMedia('(min-resolution: 2dppx)');mediaQuery.addListener(()=>{updateResponsiveImages()})}}function updateResponsiveImages(){const images=document.querySelectorAll('img.img-loaded');images.forEach(async(img)=>{const originalSrc=img.dataset.originalSrc||img.src;const newOptimizedSrc=await getOptimizedImageSrc(originalSrc,img);if(newOptimizedSrc!==img.src){img.dataset.originalSrc=originalSrc;img.src=newOptimizedSrc}})}function initImageErrorHandling(){window.addEventListener('error',(event)=>{if(event.target.tagName==='IMG'){handleImageError(event.target)}},true)}function preloadCriticalImages(){const criticalImages=document.querySelectorAll('.hero__photo,.project__image[data-featured="true"]');criticalImages.forEach(async(img)=>{try{const src=img.dataset.src||img.src;if(src&&!src.startsWith('data:')){await preloadImage(src);img.classList.add('img-preloaded')}}catch(error){console.warn('Failed to preload critical image:',error)}})}function initImageAnalytics(){if('PerformanceObserver' in window){const observer=new PerformanceObserver((list)=>{list.getEntries().forEach((entry)=>{if(entry.initiatorType==='img'){trackImageEvent('image_performance',{src: entry.name,loadTime: entry.duration,size: entry.transferSize})}})});observer.observe({entryTypes: ['resource']})}trackImageEvent('lazy_loading_initialized',{totalImages: document.querySelectorAll('img').length,lazyImages: document.querySelectorAll('img[data-src],img[loading="lazy"]').length})}function trackImageEvent(eventName,data={}){if(typeof gtag!=='undefined'){gtag('event',eventName,{'image_optimization': true,...data})}console.log(`Image event: ${eventName}`,data)}function loadAllImages(){const lazyImages=document.querySelectorAll('img[data-src]');lazyImages.forEach(img=>{img.src=img.dataset.src;delete img.dataset.src;setupLazyImage(img)})}function loadImageManually(img){if(intersectionObserver){intersectionObserver.unobserve(img)}loadImage(img)}function getImageStats(){const allImages=document.querySelectorAll('img');const loadedImages=document.querySelectorAll('img.img-loaded');const errorImages=document.querySelectorAll('img.img-error');const lazyImages=document.querySelectorAll('img.img-lazy');return{total: allImages.length,loaded: loadedImages.length,errors: errorImages.length,lazy: lazyImages.length,loadingProgress: Math.round((loadedImages.length/allImages.length)*100)}}document.addEventListener('DOMContentLoaded',function(){initImageOptimization()});window.ImageOptimization={initImageOptimization,loadImageManually,getImageStats,trackImageEvent};